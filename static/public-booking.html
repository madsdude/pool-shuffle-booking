<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book bord</title>

  <!-- Favicon / branding -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/img/logo.png">
  <link rel="apple-touch-icon" href="/static/img/logo.png">
  <meta name="theme-color" content="#0f172a">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Hero fylder hele viewporten */
    .hero-wrap { position: relative; height: 100dvh; min-height: 560px; overflow: hidden; }
    .hero-wrap img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: saturate(1.05); }
    .hero-wrap::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0) 55%, rgba(0,0,0,.22) 100%); pointer-events: none; }
    /* Center booking-kortet ovenpå hero */
    .hero-center { position: relative; z-index: 2; height: 100%; display: grid; place-items: center; padding: 16px; }
    .booking-card { width: 100%; max-width: 900px; background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 24px 48px rgba(0,0,0,.22); }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <!-- ÉN hero med centreret booking-kort -->
  <section class="hero-wrap">
    <img src="/static/img/hero.jpg" alt="Pool Hall Randers" />
    <div class="hero-center">
      <div class="booking-card p-4 sm:p-6">
        <h1 class="text-2xl font-bold mb-4">Book bord</h1>

        <div id="alert" class="hidden mb-4 p-3 rounded text-sm"></div>

        <form id="bookForm" class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm font-medium">Bord</span>
              <select id="resource" class="mt-1 w-full border rounded p-2" required></select>
            </label>

            <label class="block">
              <span class="text-sm font-medium">Dato</span>
              <input id="date" type="date" class="mt-1 w-full border rounded p-2" required />
            </label>
          </div>

          <div class="grid sm:grid-cols-3 gap-4">
            <label class="block">
              <span class="text-sm font-medium">Start</span>
              <input id="start" type="time" step="60" class="mt-1 w-full border rounded p-2" required />
            </label>

            <label class="block">
              <span class="text-sm font-medium">Varighed</span>
              <select id="duration" class="mt-1 w-full border rounded p-2">
                <option value="60" selected>1 time</option>
                <option value="90">1½ time</option>
                <option value="120">2 timer</option>
              </select>
            </label>

            <label class="block">
              <span class="text-sm font-medium">Slut (auto)</span>
              <input id="end" type="time" step="60" class="mt-1 w-full border rounded p-2 bg-gray-100" disabled />
            </label>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm font-medium">Navn</span>
              <input id="name" type="text" class="mt-1 w-full border rounded p-2" placeholder="Fornavn Efternavn" required />
            </label>

            <label class="block">
              <span class="text-sm font-medium">Telefon (valgfri)</span>
              <input id="phone" type="tel" class="mt-1 w-full border rounded p-2" placeholder="fx 12 34 56 78" />
            </label>
          </div>

          <div class="flex items-center gap-3 pt-2">
            <button id="submitBtn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" type="submit">
              Tjek & book
            </button>
            <span id="busy" class="text-sm text-gray-500 hidden">Arbejder…</span>
          </div>
        </form>

        <div class="mt-8">
          <h2 class="text-lg font-semibold mb-2">Bookinger for valgt bord og dato</h2>
          <div id="dayList" class="bg-white border rounded-xl p-4 sm:p-6 text-sm space-y-2">
            <div class="text-gray-500">Vælg bord og dato…</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
  // ---------- KONSTANTER (offentlig online booking) ----------
  // Kun fredag (5) og lørdag (6) — JS getDay(): 0=søn .. 6=lør
  const ALLOWED_DAYS = [5, 6];
  // Vindue: 15:00 til 23:00 (seneste sluttid). Vi regner i minutter.
  const OPEN_MIN = 19 * 60;
  const CLOSE_MIN = 23 * 60;

  // ---------- UTIL ----------
  const pad = n => String(n).padStart(2,'0');
  const $ = id => document.getElementById(id);
  const selResource = $('resource'), inpDate = $('date'), inpStart = $('start'),
        inpDuration = $('duration'), inpEnd = $('end'), inpName = $('name'),
        inpPhone = $('phone'), dayList = $('dayList'), submitBtn = $('submitBtn'),
        busy = $('busy'), alertBox = $('alert');

  const hhmmToMin = (hhmm) => { const [h,m]=hhmm.split(':').map(Number); return h*60+m; };
  const minToHHMM = (m) => `${pad(Math.floor(m/60))}:${pad(m%60)}`;

  function showAlert(text, type='info'){
    alertBox.classList.remove('hidden');
    alertBox.textContent = text;
    alertBox.className = 'mb-4 p-3 rounded text-sm ' + (
      type==='ok' ? 'bg-green-100 text-green-800 border border-green-200' :
      type==='err' ? 'bg-red-100 text-red-800 border border-red-200' :
                     'bg-yellow-100 text-yellow-800 border border-yellow-200'
    );
    // ingen auto-hide hvis fejl
    if (type !== 'err') setTimeout(()=>alertBox.classList.add('hidden'), 5000);
  }

  function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return {y,m,d}; }
  function addMinutes(d, m){ return new Date(d.getTime() + m*60000); }

  function setDefaultDateTime(){
    const now = new Date();
    inpDate.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
    // default start til nærmeste 5. min
    const minutes = now.getMinutes();
    const roundUp = minutes % 5 === 0 ? 0 : (5 - (minutes % 5));
    const s = addMinutes(now, roundUp);
    inpStart.value = `${pad(s.getHours())}:${pad(s.getMinutes())}`;
    updateEnd();
  }

  function updateEnd(){
    const {y,m,d} = parseYMD(inpDate.value);
    const [hh,mm] = inpStart.value.split(':').map(Number);
    const start = new Date(y, m-1, d, hh, mm, 0, 0);
    const end = addMinutes(start, parseInt(inpDuration.value,10));
    inpEnd.value = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
  }

  // ---------- VINDUE-REGLER ----------
  function isAllowedDay(dStr){
    // brug T12:00 for at undgå TZ-skævhed
    const day = new Date(dStr + 'T12:00:00').getDay();
    return ALLOWED_DAYS.includes(day);
  }

  function latestStartForDuration(durMin){
    const latest = CLOSE_MIN - durMin; // skal slutte senest 23:00
    return Math.max(OPEN_MIN, latest); // hvis durMin > (CLOSE-OPEN), falder den tilbage til OPEN
  }

  function enforceWindow(){
    const dur = parseInt(inpDuration.value, 10);
    const okDay = isAllowedDay(inpDate.value);

    if(!okDay){
      submitBtn.disabled = true;
      showAlert('Online booking er kun mulig fredag og lørdag kl. 19:00–23:00.', 'err');
      // lås tid-feltet og sæt min/max for tydelighed
      inpStart.min = minToHHMM(OPEN_MIN);
      inpStart.max = minToHHMM(latestStartForDuration(dur));
      return;
    }

    // Dag er tilladt — sæt min/max ud fra varighed
    const minHH = minToHHMM(OPEN_MIN);
    const maxHH = minToHHMM(latestStartForDuration(dur));
    inpStart.min = minHH;
    inpStart.max = maxHH;

    // hvis nuværende start ligger udenfor, clamp den
    const cur = hhmmToMin(inpStart.value);
    if (cur < OPEN_MIN) inpStart.value = minHH;
    if (cur > hhmmToMin(maxHH)) inpStart.value = maxHH;

    submitBtn.disabled = false;
    // fjern info hvis den var en "ok"/"info"; behold hvis det var "err"
    if (alertBox.classList.contains('bg-yellow-100')) alertBox.classList.add('hidden');
    updateEnd();
  }

  // ---------- API ----------
  async function fetchJSON(url, opts){
    const r = await fetch(url, opts);
    if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`);
    return r.json();
  }

  async function fillResources(){
    try {
      const data = await fetchJSON('/api/resources');
      selResource.innerHTML = data.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    } catch {
      selResource.innerHTML = `<option value="1">Pool 1</option><option value="2">Pool 2</option>`;
    }
  }

  async function renderDayList(){
    const rid = parseInt(selResource.value,10);
    if(!rid || !inpDate.value) return;
    dayList.innerHTML = '<div class="text-gray-500">Henter bookinger…</div>';
    try{
      const list = await fetchJSON(`/api/bookings?date=${inpDate.value}`);
      const rows = list.filter(b => Number(b.resource_id) === rid)
                       .sort((a,b)=> new Date(a.start_iso_local)-new Date(b.start_iso_local));
      if(!rows.length){
        dayList.innerHTML = '<div class="text-gray-500">Ingen bookinger endnu.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      for(const b of rows){
        const s = new Date(b.start_iso_local), e = new Date(b.end_iso_local);
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between border rounded p-2';
        div.innerHTML = `<div>
            <div class="font-medium">${s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
            – ${e.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
            <div class="text-gray-600">${b.name || '—'}${b.phone ? ' · ' + b.phone : ''}</div>
          </div>
          <span class="text-xs text-gray-500">#${b.id}</span>`;
        frag.appendChild(div);
      }
      dayList.innerHTML = ''; dayList.appendChild(frag);
    }catch(e){
      dayList.innerHTML = '<div class="text-red-600">Kunne ikke hente bookinger.</div>';
    }
  }

  // ---------- SUBMIT ----------
  async function onSubmit(e){
    e.preventDefault();

    // HÅRD VALIDERING af vinduet
    const dur = parseInt(inpDuration.value, 10);
    if(!isAllowedDay(inpDate.value)){
      showAlert('Online booking er kun mulig fredag og lørdag kl. 15:00–23:00.', 'err');
      return;
    }
    const startMin = hhmmToMin(inpStart.value);
    const lastStart = latestStartForDuration(dur);
    if(startMin < OPEN_MIN || startMin > lastStart){
      showAlert(`Vælg start mellem ${minToHHMM(OPEN_MIN)} og ${minToHHMM(lastStart)}.`, 'err');
      return;
    }

    submitBtn.disabled = true; busy.classList.remove('hidden');
    try{
      const rid = parseInt(selResource.value,10);
      const name = inpName.value.trim();
      const phone = inpPhone.value.trim() || null;
      const date = inpDate.value;
      const start_time = inpStart.value;
      const want = dur; // 60/90/120

      // 1) Opret 60 min booking
      const createRes = await fetch('/api/bookings', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ resource_id: rid, name, phone, date, start_time, is_public: true })
      });

      if(!createRes.ok){
        let msg = await createRes.text();
        try { const j = JSON.parse(msg); msg = j.detail || msg; } catch {}
        throw new Error(msg || 'Kunne ikke oprette booking');
      }

      const created = await createRes.json(); // { id, ... }

      // 2) Forlæng hvis > 60 min — stadig inden kl. 23:00
      if(want > 60){
        const add = want - 60; // 30 eller 60
        const upd = await fetch(`/api/bookings/${created.id}`, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ add_minutes: add })
        });
        if(!upd.ok){
          let msg = await upd.text();
          try { const j = JSON.parse(msg); msg = j.detail || msg; } catch {}
          showAlert('Booket 60 min, men kunne ikke forlænge: ' + (msg || upd.status), 'err');
        }
      }

      showAlert('Booking oprettet ✔️', 'ok');
      await renderDayList();
    }catch(err){
      showAlert(err?.message || String(err), 'err');
    }finally{
      submitBtn.disabled = false; busy.classList.add('hidden');
    }
  }

  // ---------- events & init ----------
  inpDuration.addEventListener('change', () => { updateEnd(); enforceWindow(); });
  inpStart.addEventListener('change', () => { updateEnd(); enforceWindow(); });
  selResource.addEventListener('change', renderDayList);
  inpDate.addEventListener('change', () => { enforceWindow(); renderDayList(); });
  document.getElementById('bookForm').addEventListener('submit', onSubmit);

  (async () => {
    await fillResources();
    setDefaultDateTime();
    enforceWindow();        // sæt min/max og evt. disable
    await renderDayList();
  })();
  </script>
</body>
</html>
