<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book bord</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto p-4 sm:p-6">
    <h1 class="text-2xl font-bold mb-4">Book bord</h1>

    <div id="alert" class="hidden mb-4 p-3 rounded text-sm"></div>

    <form id="bookForm" class="bg-white rounded-xl shadow p-4 sm:p-6 space-y-4">
      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm font-medium">Bord</span>
          <select id="resource" class="mt-1 w-full border rounded p-2" required></select>
        </label>

        <label class="block">
          <span class="text-sm font-medium">Dato</span>
          <input id="date" type="date" class="mt-1 w-full border rounded p-2" required />
        </label>
      </div>

      <div class="grid sm:grid-cols-3 gap-4">
        <label class="block">
          <span class="text-sm font-medium">Start</span>
          <input id="start" type="time" step="60" class="mt-1 w-full border rounded p-2" required />
        </label>

        <label class="block">
          <span class="text-sm font-medium">Varighed</span>
          <select id="duration" class="mt-1 w-full border rounded p-2">
            <option value="30">30 min</option>
            <option value="60" selected>1 time</option>
            <option value="90">1½ time</option>
            <option value="120">2 timer</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm font-medium">Slut (auto)</span>
          <input id="end" type="time" step="60" class="mt-1 w-full border rounded p-2 bg-gray-100" disabled />
        </label>
      </div>

      <div class="grid sm:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm font-medium">Navn</span>
          <input id="name" type="text" class="mt-1 w-full border rounded p-2" placeholder="Fornavn Efternavn" required />
        </label>

        <label class="block">
          <span class="text-sm font-medium">Telefon (valgfri)</span>
          <input id="phone" type="tel" class="mt-1 w-full border rounded p-2" placeholder="fx 12 34 56 78" />
        </label>
      </div>

      <div class="flex items-center gap-3 pt-2">
        <button id="submitBtn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" type="submit">
          Tjek & book
        </button>
        <span id="busy" class="text-sm text-gray-500 hidden">Arbejder…</span>
      </div>
    </form>

    <div class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Bookinger for valgt bord og dato</h2>
      <div id="dayList" class="bg-white rounded-xl shadow p-4 sm:p-6 text-sm space-y-2">
        <div class="text-gray-500">Vælg bord og dato…</div>
      </div>
    </div>
  </div>

  <script>
  // ---------- FALDBACK RESSOURCER (bruges kun hvis /api/resources ikke findes) ----------
  const FALLBACK_RESOURCES = [
    { id: 1, name: "Pool 1" },
    { id: 2, name: "Pool 2" },
    { id: 3, name: "Pool 3" },
    { id: 4, name: "Shuffleboard 1" }
  ];

  // ---------- UTIL ----------
  const pad = n => String(n).padStart(2,'0');

  function toLocalISO(d) {
    const off = -d.getTimezoneOffset();
    const sign = off >= 0 ? '+' : '-';
    const hh = pad(Math.floor(Math.abs(off)/60));
    const mm = pad(Math.abs(off)%60);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${hh}:${mm}`;
  }

  function addMinutes(d, mins) {
    return new Date(d.getTime() + mins*60*1000);
  }

  function overlap(aStart, aEnd, bStart, bEnd) {
    return aStart < bEnd && aEnd > bStart;
  }

  function parseYMD(dateStr) {
    const [y,m,d] = dateStr.split('-').map(x=>parseInt(x,10));
    return {y,m,d};
  }

  function showAlert(text, type='info') {
    const box = document.getElementById('alert');
    box.classList.remove('hidden');
    box.textContent = text;
    box.className = 'mb-4 p-3 rounded text-sm ' + (type==='ok' ? 'bg-green-100 text-green-800 border border-green-200'
                                              : type==='err' ? 'bg-red-100 text-red-800 border border-red-200'
                                                             : 'bg-yellow-100 text-yellow-800 border border-yellow-200');
    setTimeout(()=>{ box.classList.add('hidden'); }, 5000);
  }

  // ---------- API ----------
  async function apiResources() {
    try {
      const r = await fetch('/api/resources');
      if (!r.ok) throw 0;
      return await r.json();
    } catch {
      return FALLBACK_RESOURCES; // så siden virker, også hvis endpoint mangler
    }
  }

  async function apiBookingsRange(fromISO, toISO) {
    // Prøv ?from / ?to — hvis ikke understøttet, fald tilbage til /api/bookings (og filter klient-side)
    try {
      const r = await fetch(`/api/bookings?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}`);
      if (r.ok) return await r.json();
    } catch {}
    try {
      const r2 = await fetch('/api/bookings');
      if (r2.ok) return await r2.json();
    } catch {}
    return [];
  }

  async function apiCreateBooking(payload) {
    const r = await fetch('/api/bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    return r;
  }

  // ---------- UI & LOGIK ----------
  const selResource = document.getElementById('resource');
  const inpDate     = document.getElementById('date');
  const inpStart    = document.getElementById('start');
  const inpDuration = document.getElementById('duration');
  const inpEnd      = document.getElementById('end');
  const inpName     = document.getElementById('name');
  const inpPhone    = document.getElementById('phone');
  const dayList     = document.getElementById('dayList');
  const submitBtn   = document.getElementById('submitBtn');
  const busy        = document.getElementById('busy');

  function setDefaultDateTime() {
    const now = new Date();
    // Dato = i dag
    inpDate.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
    // Start = næste hele 5 min
    const minutes = now.getMinutes();
    const roundUp = minutes % 5 === 0 ? 0 : (5 - (minutes % 5));
    const s = addMinutes(now, roundUp);
    inpStart.value = `${pad(s.getHours())}:${pad(s.getMinutes())}`;
    updateEnd();
  }

  function updateEnd() {
    const {y,m,d} = parseYMD(inpDate.value);
    const [sh, sm] = inpStart.value.split(':').map(Number);
    const start = new Date(y, m-1, d, sh, sm, 0, 0);
    const end = addMinutes(start, parseInt(inpDuration.value,10));
    inpEnd.value = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
  }

  async function fillResources() {
    const data = await apiResources();
    selResource.innerHTML = '';
    for (const r of data) {
      const opt = document.createElement('option');
      opt.value = r.id;
      opt.textContent = r.name;
      selResource.appendChild(opt);
    }
  }

  async function renderDayList() {
    const rid = parseInt(selResource.value, 10);
    if (!rid || !inpDate.value) return;
    dayList.innerHTML = '<div class="text-gray-500">Henter bookinger…</div>';

    // Lav dagsinterval [00:00, 23:59:59] i lokal tid
    const {y,m,d} = parseYMD(inpDate.value);
    const from = new Date(y, m-1, d, 0, 0, 0, 0);
    const to   = new Date(y, m-1, d, 23, 59, 59, 999);

    const bookings = (await apiBookingsRange(toLocalISO(from), toLocalISO(to)))
      .filter(b => Number(b.resource_id) === rid);

    if (!bookings.length) {
      dayList.innerHTML = '<div class="text-gray-500">Ingen bookinger endnu.</div>';
      return;
    }

    // Sortér efter start
    bookings.sort((a,b)=> new Date(a.start_iso_local) - new Date(b.start_iso_local));

    const frag = document.createDocumentFragment();
    for (const b of bookings) {
      const s = new Date(b.start_iso_local), e = new Date(b.end_iso_local);
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between border rounded p-2';
      row.innerHTML = `
        <div>
          <div class="font-medium">${s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
          – ${e.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          <div class="text-gray-600">${b.name || '—'}${b.phone ? ' · ' + b.phone : ''}</div>
        </div>
        <span class="text-xs text-gray-500">#${b.id}</span>
      `;
      frag.appendChild(row);
    }
    dayList.innerHTML = '';
    dayList.appendChild(frag);
  }

 async function onSubmit(e) {
  e.preventDefault();
  submitBtn.disabled = true; busy.classList.remove('hidden');

  try {
    const rid = parseInt(selResource.value,10);
    const {y,m,d} = parseYMD(inpDate.value);
    const [sh, sm] = inpStart.value.split(':').map(Number);

    // Bruges kun til overlap-tjek i UI
    const start = new Date(y, m-1, d, sh, sm, 0, 0);
    let end = addMinutes(start, parseInt(inpDuration.value,10));
    if (end <= start) end = addMinutes(end, 24*60); // håndtér efter midnat

    // Hent dagens bookinger for overlap-tjek
    const from = new Date(y, m-1, d, 0, 0, 0, 0);
    const to   = new Date(y, m-1, d, 23, 59, 59, 999);
    const bookings = (await apiBookingsRange(toLocalISO(from), toLocalISO(to)))
      .filter(b => Number(b.resource_id) === rid);

    const clash = bookings.find(b => {
      const bs = new Date(b.start_iso_local), be = new Date(b.end_iso_local);
      return overlap(start, end, bs, be);
    });
    if (clash) {
      showAlert('Tiden overlapper en eksisterende booking. Vælg en anden tid.', 'err');
      return;
    }

    // ⬇️ VIGTIGT: payload matcher dit API-krav
    const payload = {
      resource_id: rid,
      name: inpName.value.trim(),
      phone: inpPhone.value.trim(),
      date: inpDate.value,                        // "YYYY-MM-DD"
      start_time: inpStart.value,                 // "HH:MM"
      duration_minutes: parseInt(inpDuration.value, 10)  // 30/60/90/120
      // Hvis din backend hellere vil have 'hour' i stedet:
      // hour: parseInt(inpStart.value.split(':')[0], 10)
    };

    const res = await apiCreateBooking(payload);
    if (res.ok) {
      showAlert('Booking oprettet ✔️', 'ok');
      await renderDayList();
    } else {
      let msg = await res.text();
      try { const j = JSON.parse(msg); msg = j.detail || msg; } catch {}
      showAlert(msg || 'Kunne ikke oprette booking.', 'err');
    }
  } catch (err) {
    showAlert(err?.message || String(err), 'err');
  } finally {
    submitBtn.disabled = false; busy.classList.add('hidden');
  }
}


      const res = await apiCreateBooking(payload);
      if (res.ok) {
        showAlert('Booking oprettet ✔️', 'ok');
        await renderDayList();
      } else {
        const txt = await res.text();
        showAlert(txt || 'Kunne ikke oprette booking.', 'err');
      }
    } catch (err) {
      showAlert(err?.message || String(err), 'err');
    } finally {
      submitBtn.disabled = false; busy.classList.add('hidden');
    }
  }

  // events
  inpDuration.addEventListener('change', updateEnd);
  inpStart.addEventListener('change', updateEnd);
  selResource.addEventListener('change', renderDayList);
  inpDate.addEventListener('change', renderDayList);
  document.getElementById('bookForm').addEventListener('submit', onSubmit);

  // init
  (async () => {
    await fillResources();
    setDefaultDateTime();
    await renderDayList();
  })();
  </script>
</body>
</html>
